<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Астрофізичний AR-симулятор: Демо</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #ar-button {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 9999;
          padding: 15px 30px;
          background: #667eea;
          color: white;
          text-decoration: none;
          border-radius: 25px;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          font-size: 1.2rem;
          cursor: pointer;
          border: none;
          outline: none;
          transition: background 0.3s ease;
      }
      #ar-button:hover {
          background: #5a67d8;
      }
    </style>
  </head>
  <body>
    <script>
      const day = 24.0 * 60 * 60; // Секунд в одному дні
      const G = 6.67e-11; // Гравітаційна стала
      const K = 1e9; // Коефіцієнт масштабування для візуалізації (1 A-Frame одиниця = 1 мільярд метрів)

      AFRAME.registerComponent('planet', {
        schema: {
          name: {type: 'string', default: ""},
          dist: {type: 'number', default: 0}, // Початкова відстань від центральної точки (Сонця) в метрах
          mass: {type: 'number', default: 0},
          T: {type: 'number', default: 0}, // Період обертання в днях (для розрахунку початкової швидкості)
          v: {type: 'array', default: [0,0,0]}, // Вектор швидкості [м/с]
          a: {type: 'array', default: [0,0,0]}, // Вектор прискорення [м/с^2]
          pos: {type: 'array', default: [0,0,0]} // Вектор позиції [м]
        },

        init: function () {
          // Ініціалізація позиції та швидкості на основі dist та T
          if (this.data.T > 0) {
            this.data.pos[0] = this.data.dist; // Початкова позиція по X
            // Обчислення початкової швидкості для кругової орбіти навколо Сонця
            const centralMass = 1.989e30; // Маса Сонця
            this.data.v[1] = Math.sqrt((G * centralMass) / this.data.dist); // v = sqrt(GM/r)
          } else {
            // Для Сонця (центральний об'єкт)
            this.data.pos = [0, 0, 0];
            this.data.v = [0, 0, 0];
          }

          // Встановлення початкової візуальної позиції (ділимо на K для масштабування метрів до A-Frame одиниць)
          this.el.setAttribute('position', `${this.data.pos[0]/K} ${this.data.pos[1]/K} ${this.data.pos[2]/K}`);
        }
      });

      AFRAME.registerComponent('main', {
        init: function() {
          this.solar_system = document.querySelectorAll('[planet]'); // Отримуємо всі об'єкти з компонентом 'planet'
        },

        tick: function (time, deltaTime) {
          const dt = day / (24 * 60); // Крок часу для симуляції (1 "ігровий" крок = 1/1440 частина земного дня)

          for (var i = 0; i < this.solar_system.length; i++) {
            let planet_i_el = this.solar_system[i];
            let planet_i = planet_i_el.getAttribute('planet');

            if (!planet_i) continue;

            planet_i.a = [0, 0, 0]; // Скидаємо прискорення для поточної планети

            for (var j = 0; j < this.solar_system.length; j++) {
              if (i === j) continue; // Не обчислюємо гравітацію планети на саму себе

              let planet_j_el = this.solar_system[j];
              let planet_j = planet_j_el.getAttribute('planet');

              if (!planet_j) continue;

              // Вектор від планети i до планети j
              let deltapos = [
                planet_j.pos[0] - planet_i.pos[0],
                planet_j.pos[1] - planet_i.pos[1],
                planet_j.pos[2] - planet_i.pos[2]
              ];

              // Відстань між планетами
              let r = Math.sqrt(
                Math.pow(deltapos[0], 2) +
                Math.pow(deltapos[1], 2) +
                Math.pow(deltapos[2], 2)
              );

              if (r < 1e7) r = 1e7; // Запобігаємо діленню на нуль або дуже малі значення (збільшено мінімальний r для стабільності)

              // Обчислення гравітаційного прискорення (a = GM/r^2 * (deltapos/r))
              for (var k = 0; k < 3; k++) {
                planet_i.a[k] += G * planet_j.mass * deltapos[k] / Math.pow(r, 3);
              }
            }

            // Оновлення швидкості (v = v + a*dt)
            for (var k = 0; k < 3; k++) {
              planet_i.v[k] += planet_i.a[k] * dt;
            }

            // Оновлення позиції (pos = pos + v*dt)
            for (var k = 0; k < 3; k++) {
              planet_i.pos[k] += planet_i.v[k] * dt;
            }

            // Оновлення візуальної позиції в A-Frame сцені (ділимо на K)
            this.solar_system[i].setAttribute('position',
              `${planet_i.pos[0]/K} ${planet_i.pos[1]/K} ${planet_i.pos[2]/K}`
            );

            // Оновлення даних компонента 'planet'
            planet_i_el.setAttribute('planet', planet_i);
          }
        }
      });
    </script>

    <a-scene webxr="optionalAR: true;">
      <a-assets>
        <a-asset-item id="sun-model" src="./assets/models/sun.glb"></a-asset-item>
        <a-asset-item id="mercury-model" src="./assets/models/mercury.glb"></a-asset-item>
        <a-asset-item id="venus-model" src="./assets/models/venus.glb"></a-asset-item>
        <a-asset-item id="earth-model" src="./assets/models/earth.glb"></a-asset-item>
        <a-asset-item id="moon-model" src="./assets/models/moon.glb"></a-asset-item>
        <a-asset-item id="mars-model" src="./assets/models/mars.glb"></a-asset-item>
        <a-asset-item id="jupiter-model" src="./assets/models/jupiter.glb"></a-asset-item>
        <a-asset-item id="saturn-model" src="./assets/models/saturno.glb"></a-asset-item>
        <a-asset-item id="uranus-model" src="./assets/models/uranus.glb"></a-asset-item>
        <a-asset-item id="neptune-model" src="./assets/models/neptuno.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 2 5" look-controls wasd-controls></a-camera>

      <a-entity id="solar-system-container" scale="0.05 0.05 0.05" position="0 0 0">

        <a-entity gltf-model="#sun-model"
                  planet="dist: 0; mass: 1.989e30; T: 0; name: Sun"
                  scale="20 20 20"> </a-entity>

        <a-entity gltf-model="#mercury-model"
                  planet="dist: 57.910e9; mass: 3.285e23; T: 88; name: Mercury"
                  scale="0.8 0.8 0.8">
        </a-entity>

        <a-entity gltf-model="#venus-model"
                  planet="dist: 108.2e9; mass: 4.876e24; T: 224.7; name: Venus"
                  scale="1.5 1.5 1.5">
        </a-entity>

        <a-entity id="earth-orbit-anchor"
                  planet="dist: 149.6e9; mass: 6e24; T: 365; name: Earth">
            <a-entity gltf-model="#earth-model" scale="2 2 2"></a-entity> <a-entity gltf-model="#moon-model"
                      position="0.1 0 0" scale="0.5 0.5 0.5"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 2700; easing: linear;"></a-entity>
        </a-entity>

        <a-entity gltf-model="#mars-model"
                  planet="dist: 227.9e9; mass: 6.39e23; T: 687; name: Mars"
                  scale="1 1 1">
        </a-entity>

        <a-entity gltf-model="#jupiter-model"
                  planet="dist: 778.5e9; mass: 1.898e27; T: 4330; name: Jupiter"
                  scale="5 5 5">
        </a-entity>

        <a-entity gltf-model="#saturn-model"
                  planet="dist: 1433.5e9; mass: 5.683e26; T: 10756; name: Saturn"
                  scale="4 4 4">
        </a-entity>

        <a-entity gltf-model="#uranus-model"
                  planet="dist: 2877.3e9; mass: 8.681e25; T: 30687; name: Uranus"
                  scale="3 3 3">
        </a-entity>

        <a-entity gltf-model="#neptune-model"
                  planet="dist: 4498.4e9; mass: 1.024e26; T: 60190; name: Neptune"
                  scale="3 3 3">
        </a-entity>

        <a-entity main></a-entity> </a-entity> <a-light type="ambient" color="#BBB"></a-light>
      <a-light type="directional" color="#FFF" intensity="0.6" position="-1 1 1"></a-light>

      <a-sky color="black"></a-sky>
    </a-scene>
  </body>
</html>